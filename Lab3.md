# Лабораторная работа №3

## Цель

Изучение прерываний микроконтроллера. Использование прерывания таймера для формирования временных задержек.

## Оборудование

1. Миниблок микроконтроллера AT90USB162
2. Вспомогательный миниблок с четырьмя светодиодами
3. Вспомогательный миниблок с семисегментным светодиодным индикатором
4. Провода соединительные
5. Кабель USB - miniUSB
6. Блок БИЦУ (наборное поле с источником питания)
7. ПК с ОС GNU/Linux Ubuntu

## Теоретические сведения

### Общие свеления о прерываниях

Прерывание - сигнал, сообщающий о наступлении какого-либо события (переполнение счетчика таймера, завершение преобразования АЦП и т.д.). При этом выполнение текущей последовательности команд прерывается, и управление передается обработчику прерывания, который в свою очередь корректно реагирует на событие и обрабатывает его, после чего управление передается  прерванной программе.

Прерывания позволяют своевременно обрабатывать события периферийных устройств, таких как таймеры, АЦП, приемопередатчики и т.д.

Прерывания можно разделить на:

 - Внутренние прерывания - обработчики сигналов, поступающих от внутренней периферии контроллера (Таймеры/Счетчики, АЦП, UART и т.д.).
 - Внешние прерывания - обработчики сигналов, поступающих от внешних устройств. Именно внешние прерывания позволяют реализовать счетчики импульсов, измерять частоту внешнего сигнала, а так же быстро реагировать на события внешних периферийных устройств.

Внешние прерывания возникают при изменении логического уровня на определенных ножках микроконтроллера.

Каждому прерыванию поставлен в соответствие некоторый адрес (абсолютный или относительный), по которому должна располагаться команда безусловной передачи управления процедуре обслуживания данного прерывания. Совокупность адресов, задействованных системой прерываний, называют **таблицей векторов прерываний**, которая размещается с нулевого адреса памяти программ. Элементы таблицы векторов прерываний называются **векторами прерываний**. По нулевому адресу находится **вектор сброса** микроконтроллера. Количество векторов прерываний зависит от модели микроконтроллера. Таблица прерываний, устанавливающая связь прерывающего события с адресом вектора прерывания, может быть найдена в заголовочном файле конкретного микроконтроллера.

### Прерывания таймера

Таймеры/счетчики способны вырабатывать запросы прерываний, переключая процессор на их обслуживание по событиям и освобождая его от необходимости периодического опроса состояния таймеров. Поскольку основное применение микроконтроллеры находят в системах реального времени, таймеры/счетчики являются одним из наиболее важных элементов.

Микроконтроллер AT90USB162 имеет один 8-битный таймер/счетчик `T0` и один 16-битный таймер/счетчик `T1`.

Для работы с таймерами/счетчиками используются регистры: `TCCR*` (регистр конфигурации), `TCNT*` (счетный регистр), `OCR*` (регистр сравнения), `TIMSK*` (регистр включения прерывания таймера).

Счетные импульсы на таймеры `T0` и `T1` поступают от предварительного делителя частоты (предделитель), подключенного непосредственно к тактовому генератору микроконтроллера.

Для включения/выключения таймера `T0` в три младших бита регистра управления `TCCR0B`, а для таймера `T1` – в `TCCR1B`, записывается значение от 0 до 5. Соответствие между числом N, записываемым в младшие биты регистра управления таймера `TCCR*`, и частотой счетных импульсов `Fсчетн`, поступающих на таймер, показано в таблице 3.1:

Таблица 3.1. Состояния битов регистра `TCCR*` для настройки таймеров

|     N    |     0      |     1      |     2      |     3      |     4      |     5      |
|----------|------------|------------|------------|------------|------------|------------|
| `TCCRxB` | 0bxxxxx000 | 0bxxxxx001 | 0bxxxxx010 | 0bxxxxx011 | 0bxxxxx100 | 0bxxxxx101 |
| `Fсчетн` |  останов   |  `F_CPU`   | `F_CPU`/8  | `F_CPU`/64 |`F_CPU`/256 |`F_CPU`/1024|

`F_CPU` - частота тактового генератора микроконтроллера.

8-битный таймер `T0` может отсчитывать до $2^8 = 256$ импульсов без переполнения. При переполнении возникает прерывание, и таймер начинает отсчет импульсов от 0.

Максимальное время, в течение которого 8-битный таймер `T0` может считать импульсы при частоте тактового генератора 1 МГц и предделителе 1024 составляет:

$$τ_{T0} = 1024\cdot 2^8/1000000 = 0,262 c = 262 мс.$$

Максимальное время, в течение которого 16-битный таймер `T1` может считать импульсы при частоте тактового генератора 1 МГц и предделителе 1024 составляет:

$$τ_{T1} = 1024\cdot 2^{16}/1000000 = 67,108 c.$$

Таким образом, таймер `T0` можно использовать для формирования мили- и микросекундных временных задержек, а таймер `T1` – секундных.

По умолчанию  таймер начинает отсчет импульсов с нуля. Для того чтобы настроить таймер для отсчета нужного числа импульсов до переполнения, необходимо записать начальное значение таймера в регистровую пару `TCNT1`.

Вычисление числа импульсов для отсчета времени 0,5 с (для тактовой частоты 1 МГц и предделителя 1024):

$$N = 0,5\cdot 1000000/1024 = 488,3 ≈ 488.$$

![Timer T1 time axis](/img/timer_time_axis.png)

Таким образом, в счетный регистр `TCNT1` необходимо записать число $65535-488$.

Для останова таймера необходимо записать 0 в регистр конфигурации `TCCR*` соответсвующего таймера.

> [!NOTE]  
> **Замечание 1**: при работе с прерываниями необходимо подключить заголовочный файл `#include <avr/interrupt.h>`.

> [!NOTE]  
> **Замечание 2**: после переполнения таймер начинает отсчет с нуля, поэтому для поддержания отсчета требуемого интервала времени в обработчике прерывания по переполнению таймера необходимо переинициализировать счетный регистр `TCNT1`.

> [!NOTE]  
> **Замечание 3**: по умолчанию (при запуске микроконтроллера) все прерывания глобально запрещены. Для глобального разрешения прерываний, необходимо выполнить команду: `sei();`. Для глобального запрещения прерываний необходимо выполнить команду: `cli();`.


## Ход работы

1. Подключите блок БИЦУ к источнику питания
2. Подключите миниблок с микроконроллером AT90USB162 к компьютеру, используя кабель miniUSB
3. Установите миниблок с микроконроллером AT90USB162 на наборное поле блока БИЦУ
4. Соберите схему в соответствии с рекомендуемой схемой соединений
5. В программе Geany создайте новый проект

Написать программу на языке Си. Код программы для мигания светодиодом, подключенным к линии `PB0` представлен в листинге 3.1. Для успешной компиляции файл с исходным кодом необходимо назвать `main.c`.

Листинг 3.1. Мигание светодиодом с использованием прерывания таймера по переполнению:

```C
#define F_CPU 1000000UL // Директива установки частоты микроконтроллера

#include <avr/io.h>
#include <avr/interrupt.h>

int main(void)
{
	// Инициализация портов ввода/вывода
	DDRB |= (1<<PB0);		// вывод управления светодиодом, работает на выход
	PORTB &= ~(1<<PB0);		// при старте МК светодиод выключен

	// Инициализация таймера/счетчика T1
	TCCR1A = 0;				// таймер работает в обычном режиме, 
	TCCR1B = 5;				// с коэффициентом предделителя 1024
	TCNT1 = 65535-488;		// начало отсчета
	TIMSK1 |= (1<<TOIE1);	// разрешение прерывания по переполнению таймера T1

	sei();					// разрешение прерывания					
	
    while(1)
    {
		asm volatile("nop"::);	// NOP - no operation
    }
} 

//прерывание при переполнении таймера T1
ISR(TIMER1_OVF_vect)
{
	// Этот код будет повторяться каждые 0,5 с

	// Переинициализация счетного регистра
	TCNT1 = 65535-488;
	
	// Инвертировать бит в позиции PB0
	PORTB ^= (1<<PB0);
}
```

Листинг 3.2. Мигание светодиодом с интервалом 5 секунд:

```C
#define F_CPU 1000000UL // Директива установки частоты микроконтроллера

#include <avr/io.h>
#include <avr/interrupt.h>

volatile uint8_t counter = 0; // Счетчик секунд

int main(void)
{
	// Инициализация портов ввода/вывода
	DDRB |= (1<<PB0);		// вывод управления светодиодом, работает на выход
	PORTB &= ~(1<<PB0);		// при старте МК светодиод выключен

	// Инициализация таймера/счетчика T1
	TCCR1A = 0;				// таймер работает в обычном режиме, 
	TCCR1B = 5;				// с коэффициентом предделителя 1024
	TCNT1 = 65535-977;		// начало отсчета
	TIMSK1 |= (1<<TOIE1);	// разрешение прерывания по переполнению таймера T1

	sei();					// разрешение прерывания					
	
    while(1)
    {
		if (counter == 5)
		{
			PORTB |= (1<<PB0);
		}
		else if (counter == 10)
		{
			PORTB &= ~(1<<PB0);
			counter = 0;
		}
    }
} 

//прерывание при переполнении таймера T1
ISR(TIMER1_OVF_vect)
{
	// Этот код будет повторяться каждую секунду

	// Переинициализация счетного регистра
	TCNT1 = 65535-977;
	
	// Инкрементировать счетчик
	counter++;
}
```

> [!NOTE]  
> Переменная `counter` объявлена с ключевым словом `volatile`. Оно необходимо в тех случаях, когда переменная используется в прерывании.


Скомпилировать полученный код (см. [Компиляция](Software.md#компиляция-программ-на-языке-c) или с помощью [Makefile](Software.md#make-и-makefile)).

Перевести микроконтроллер в режим программирования: одновременно нажать кнопки "СБРОС" и "ПРОГ", отпустить "СБРОС", затем отпустить "ПРОГ". Микроконтроллер перейдет в режим программирования (DFU) и будет ожидать прошивку.

Выполнить загрузку программы в микроконтроллер (см. [Прошивка](Software.md#прошивка-микроконтроллера) или с помощью [Makefile](Software.md#make-и-makefile)).

Нажать кнопку "СБРОС", микроконтроллер перейдет в рабочий режим.

## Задания для самостоятельной работы

1. Усовершенствовать проект «Бинарные часы», используя для подсчета секунд таймер.
2. Собрать схему и написать программу, реализующие «Умный вентилятор». Вентилятор включается на 10 секунд. Во время работы вентилятора ведется обратный отсчет секунд с отображением на односекционном семисегментном индикаторе. Запуск таймера при помощи кнопки. В качестве индикатора работы вентилятора использовать светодиод.
3. Собрать схему и написать программу, реализующие «Световая волна». В линейке светодиодов каждый включает поочередно один за другим с интервалом 1/5 секунды. Задержку между переключениями организовать с помощью таймера.

## Содержание отчета

1. Титульный лист
2. Цель, задание на лабораторную работу
3. Электрическая схема
4. Алгоритм работы
5. Заключение
6. Приложения

## Контрольные вопросы

1. Что такое вектор прерывания микроконтроллера? Какие вектора прерываний имеет AT90USB162? Как активировать какой-либо вектор прерывания?
2. Сколько и какие таймеры/счетчики имеет AT90USB162?
3. Для чего нужен предделитель частоты для таймера/счетчика?
4. Назовите алгоритм настройки таймера/счетчика.
