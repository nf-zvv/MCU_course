# Лабораторная работа №5. Широтно-импульсная модуляция (ШИМ)

## Цель

Познакомиться с работой ШИМ микроконтроллера.

## Оборудование

1. Миниблок микроконтроллера ATmega16
2. Вспомогательный миниблок с четырьмя светодиодами
3. Два вспомогательных миниблока с семисегментным светодиодным индикатором
4. Провода соединительные
5. Кабель USB - miniUSB
6. Блок БИЦУ (наборное поле с источником питания)
7. ПК с ОС GNU/Linux Ubuntu

## Теоретические сведения

### Широтно-импульсная модуляция

Широтно-импульсная модуляция (pulse width modulation, PWM) часто используется в цифровой технике. AVR-микроконтроллеры имеют встроенную аппаратную возможность генерировать ШИМ-сигнал.

Широтно-импульсная модуляция - является технологией, позволяющей изменять ширину импульсов в то время как частота следования импульсов остается постоянной. В настоящее время она применяется в разнообразных системах контроля и управления, а также в различных приложениях, таких как, к примеру, управление скоростью вращения двигателей, измерениях, управление мощностью чего-либо, связь и др.

При помощи ШИМ можно управлять средним значением напряжения на нагрузке путём изменения скважности импульсов, управляющих транзисторным ключом.

![PWM VAR U](/img/pwm_var_u.gif)

Назначение ШИМ:
 - регулирование мощности в нагрузке. Регулирование мощности осуществляется периодической подачей питания в нагрузку.
 - вывод аналогового сигнала. ШИМ позволяет выполнить цифро-аналоговое преобразование (ЦАП). Нужно лишь добавить фильтр нижних частот (ФНЧ).

У микроконтроллера есть встроенные таймеры, которые и управляют формированием ШИМ-сигнала. Для использования достаточно правильно настроить таймер и затем для формирования сигнала потребуется только изменять состояние одного регистра.

![PWM](/img/pwm.png)

Здесь:
 - T – период ШИМ;
 - 1/T – частота ШИМ;
 - T/A – скважность ШИМ;
 - A/T – величина ШИМ.

### Генерация ШИМ сигнала микроконтроллером

Принцип работы ШИМ микроконтроллера можно понять по следующей картинке:

![PWM](/img/pwm_work.jpg)

Предположим, в регистр OCR1A записано значение "100".

Тактовый сигнал у задан без делителя. Период следования тактовых импульсов 1/16МГц = 62,5нс. С каждым новым тактом, состояние регистра TCNT1 увеличивается на единицу. При это постоянно происходит его сравнение с регистрами OCR1A и ICR1. Как только таймер досчитывает до значения OCR1A происходит переключение состояния вывода из "1" в "0". При достижении значения ICR1 состояние TCNT1 сбрасывается в ноль, на выводе снова выставляется "1" и начинается следующий период сигнала.

Несложно посчитать период следования импульсов составляет: 255×62,5 = 15937,5нс. Примерно 16мкс. Частота при этом 62,5кГц. Это очень большая частота и снизить ее можно увеличив предделитель или/и значение ICR1.

В итоге, чтобы изменить скважность сигнала остается только записать новое значение в регистр OCR1.

![PWM](/img/pwm_saw.png)


### ЦАП на базе ШИМ сигналов микроконтроллера

В качестве сглаживающей интегрирующей цепи в ШИМ применяется RC цепь.

![PWM DAC](/img/pwm_dac.png)

## Ход работы

1. Изучить принципы работы ШИМ микроконтроллера ATmega16u4.
2. Собрать схему на рис. 5.1 (стр. 60) из [Руководства по выполнению базовых экспериментов](/extra/920.5.pdf).
3. Скомпилировать программу (листинг 5.1) и загрузить прошивку в микроконтроллер ATmega16u4.
4. При помощи осциллографа пронаблюдать изменение ШИМ сигнала в зависимости от коэффициента заполнения.
5. Изменяя входное напряжение с помощью потенциометра, заполнить таблицу 5.2 из [Руководства по выполнению базовых экспериментов](/extra/920.5.pdf).
6. Оценить точность преобразования сигнала с помощью ЦАП на базе таймера.


Листинг 5.1. ЦАП на базе ШИМ сигналов микроконтроллера

```C
/* Exp_5 "ЦАП на базе ШИМ сигналов микроконтроллера"
 * Exp_5.с АЦП микроконтроллера программируется для ввода данных по каналу ADC0 (вывод PF0)
 * c потенциометра миниблока А4.Полученный сигнал АЦП выдается в регистр сравнения OCR1A 
 * таймера 1. При инициализации таймера 1 задан режим работы таймера с разрядностью, 
 * совпадающей с разрядностью АЦП и разрешено формирование ШИМ сигнала на выходе.
 * При задании опорного напряжения АЦП равным напряжению питания и правильной работе 
 * системы, сигнал на входе АЦП и среднее значение ШИМ сигнала должны совпасть.
 * Для получения среднего значения ШИМ сигнал таймера с вывода PB5 микроконтроллера
 * поступает на RC фильтр из элементов миниблока A3. Напряжение на емкости, является выходом
 * ЦАП.  Значения напряжения на входе АЦП и выходе ЦАП могут быть измерены с помощью 
 * мультиметра.  
 */ 

#include <avr/io.h>

int main(void)
{
	DDRB|=(1<<PB5);	//выводы управления семисегментным индикатором работают на выход
	ADMUX=0x40;		//при инициализации АЦП выбираем опорное напряжение 5 В 
				//(напряжение питания) и канал ADC0 
	TCCR1A=0x83;		//ШИМ сигнал на выводе OCR1A (PB5)? fast PWM 10бит
	TCCR1B=0x9;		//тактовая частота таймера 1 МГц
	ADCSRA=0xD2;		//первый запуск АЦП без разрешения прерываний и с тактовой
//частотой 250 кГц
	while(1)
	{
		if (ADCSRA &(1<<ADIF))
		{//закончилось очередное преобразование АЦП
			OCR1A=ADC;
			ADCSRA=0xD2;			//запускаем следующее преобразование АЦП
		}
		for(unsigned int i=0;i<10000;i++) ;	//цикл, имитирующий основную программу
	}
}

```

## Задания для самостоятельной работы

1. Измените программу добавив второй канал ЦАП.

## Содержание отчета

1. Титульный лист
2. Цель, задание на лабораторную работу
3. Электрическая схема
4. Алгоритм работы
5. Заключение
6. Приложения

## Контрольные вопросы

1. Объясните принцип работы ШИМ.
2. Назовите несколько примеров использования ШИМ.
3. Какие режимы ШИМ поддерживает микроконтроллер ATmega16u4?
4. Как настроить таймер на генерацию ШИМ сигнала?
5. Как изменить коэффициент заполнения ШИМ?
6. Объясните принцип работы ЦАП на базе ШИМ.
