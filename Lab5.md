# Лабораторная работа №5. Широтно-импульсная модуляция (ШИМ)

## Цель

Познакомиться с работой ШИМ микроконтроллера.

## Оборудование

1. Миниблок микроконтроллера ATmega16u4
2. Миниблок потенциометра
3. Миниблок RC элементов
4. Провода соединительные
5. Кабель USB - miniUSB
6. Блок БИЦУ (наборное поле с источником питания)
7. ПК с ОС GNU/Linux Ubuntu

## Теоретические сведения

### Широтно-импульсная модуляция

Широтно-импульсная модуляция (pulse width modulation, PWM) часто используется в цифровой технике. AVR-микроконтроллеры имеют встроенную аппаратную возможность генерировать ШИМ-сигнал при помощи встроенного таймера.

Широтно-импульсная модуляция - является технологией, позволяющей изменять ширину импульсов при неизменной частоте следования импульсов (т.е. период остается постоянным). В настоящее время она применяется в разнообразных системах контроля и управления, а также в различных приложениях, таких как, к примеру, управление скоростью вращения двигателей, измерениях, управление мощностью чего-либо, связь и др.

При помощи ШИМ можно управлять средним значением напряжения на нагрузке путём изменения скважности импульсов, управляющих транзисторным ключом.

![PWM VAR U](/img/pwm_var_u.gif)

Как видно, с помощью такой модуляции можно получать напряжения разных уровней. Причем в отличие ограничения тока переменным резистором с целью уменьшения напряжения метод ШИМ гораздо экономичнее. Если регулировать напряжение резистором, то на нем выделяется тепло и часть электрической энергии теряется. При ШИМ энергии теряется существенно меньше, поэтому данная модуляция активно используется в различных регуляторах напряжения и блоках питания.

Назначение ШИМ:
 - регулирование мощности в нагрузке. Регулирование мощности осуществляется периодической подачей питания в нагрузку.
 - вывод аналогового сигнала. ШИМ позволяет выполнить цифро-аналоговое преобразование (ЦАП). Нужно лишь добавить фильтр нижних частот (ФНЧ).

![PWM](/img/pwm.png)

Здесь:
 - T – период ШИМ;
 - A - длительность импульса;
 - F = 1/T – частота ШИМ;
 - S = T/A – скважность ШИМ;
 - D = A/T – коэффициент заполнения ШИМ.

### Генерация ШИМ сигнала микроконтроллером

Практически во всех современных микроконтроллерах имеются встроенные средства формирования одного или более независимых каналов ШИМ. Очень гибкие возможности конфигурации ШИМ-формирователя микроконтроллера позволяют использовать их в разнообразных схемах электронного управления и автоматики.

У микроконтроллера есть встроенные таймеры, которые и управляют формированием ШИМ-сигнала. Для использования достаточно правильно настроить таймер и затем для формирования сигнала потребуется только изменять состояние одного регистра.

Режимы работы ШИМ микроконтроллера:
 - Режим быстрой широтно-импульсной модуляции (Fast PWM);
 - Режим широтно-импульсной модуляции с фазовой коррекцией (Phase Correct);
 - Режим широтно-импульсной модуляции с фазовой и частотной коррекцией (Phase and Frequency Correct).

Режим быстрой широтно-импульсной модуляции предназначен для генерации ШИМ-импульсов повышенной частоты. В отличие от других режимов работы в этом используется однонаправленная работа счетчика. Счет выполняется в направлении от нижнего к верхнему пределу счета.

Если задан инвертирующий режим, то выход микроконтроллера `OCnx` сбрасывается при совпадении и устанавливается на верхнем пределе счета.

Разрешающая способность ШИМ может быть фиксированной 8, 9 или 10 разрядов или задаваться регистром `ICRn` или `OCRnA`, но не менее 2 разрядов и не более 16 разрядов.

В режиме быстрой ШИМ счетчик `TCNTn` инкрементируется до совпадения его значения с одним из фиксированных значений 0x00FF, 0x01FF или 0x03FF или значением в `ICRn` или значением в `OCRnA`, а затем сбрасывается следующим тактом синхронизации таймера.

Принцип работы ШИМ микроконтроллера можно понять по следующей картинке:

![PWM](/img/pwm_work.jpg)

Предположим, в регистр `OCR1A` записано значение "100".

Тактовый сигнал задан без делителя. Период следования тактовых импульсов 1/16МГц = 62,5нс. С каждым новым тактом, состояние регистра `TCNT1` увеличивается на единицу. При это постоянно происходит его сравнение с регистрами `OCR1A` и `ICR1`. Как только таймер досчитывает до значения `OCR1A` происходит переключение состояния вывода из "1" в "0". При достижении значения `ICR1` (или при переполнении таймера) состояние `TCNT1` сбрасывается в ноль, на выводе снова выставляется "1" и начинается следующий период сигнала.

Несложно посчитать период следования импульсов составляет: 255×62,5 = 15937,5нс. Примерно 16мкс. Частота при этом 62,5кГц. Это очень большая частота и снизить ее можно увеличив предделитель или/и значение `ICR1`.

В итоге, чтобы изменить скважность сигнала остается только записать новое значение в регистр `OCR1`.

![PWM](/img/pwm_saw.png)

ШИМ-сигнал формируется на выводах `OCnx` микроконтроллера:

![PWM pins](/img/atmega16u_pwm_pins.png)

### Настройка ШИМ при помощи регистров микроконтроллера

Рассматривается настройка быстрой ШИМ для таймера T1.

Для настройки ШИМ используются регистры `TCCR1A`, `TCCR1B`, `OCR1A`.

Предделитель частоты импульсов, поступающих на таймер, настраивается битами `CS12`..`CS10` регистра `TCCR1B` (см. [ЛР №3](Lab3.md)).

Выбор режима работы ШИМ задается настройками битов `WGM13`..`WGM10` регистров `TCCR1A` и `TCCR1B`.

![TCCR1A](/img/TCCR1A.png)

![TCCR1B](/img/TCCR1B.png)

Табл. 5.1. Режимы Fast PWM при выборе разрешающей способности

| WGM13 | WGM12 | WGM11 | WGM10 | Режим             | Вершина |
|-------|-------|-------|-------|-------------------|---------|
|   0   |   1   |   0   |   1   | Fast PWM, 8-bit   | 0x00FF  |
|   0   |   1   |   1   |   0   | Fast PWM, 9-bit   | 0x01FF  |
|   0   |   1   |   1   |   1   | Fast PWM, 10-bit  | 0x03FF  |
|   1   |   1   |   1   |   0   | Fast PWM          | ICR1    |
|   1   |   1   |   1   |   1   | Fast PWM          | OCR1A   |

Поведение вывода микроконтроллера `OC1A` настраивается битами `COM1A1`..`COM1A0` регистра `TCCR1A`:

Табл. 5.2. Режим работы вывода `OC1A`

| `COM1A1` | `COM1A0` | Описание |
|----------|----------|----------|
|    0     |    0     | Нормальный режим, вывод `OC1A` отключен |
|    0     |    1     | Нормальный режим, вывод `OC1A` отключен |
|    1     |    0     | `OC1A` сбрасывается при совпадении, устанавливается на вершине |
|    1     |    1     | `OC1A` устанавливается при совпадении, сбрасывается на вершине |


### ЦАП на базе ШИМ сигналов микроконтроллера

В качестве сглаживающей интегрирующей цепи в ШИМ применяется RC цепь.

![PWM DAC](/img/pwm_dac.png)

## Ход работы

1. Изучить принципы работы ШИМ микроконтроллера ATmega16u4.
2. Собрать схему на рис. 5.1.
3. Скомпилировать программу (листинг 5.1) и загрузить прошивку в микроконтроллер ATmega16u4.
4. При помощи осциллографа пронаблюдать изменение ШИМ сигнала в зависимости от коэффициента заполнения. Сделать скриншоты осцилограммы при различных коэффициентах заполнения.
5. Изменяя входное напряжение с помощью потенциометра, заполнить таблицу 5.3. При этом щуп мультиметра нужно периодически подключать к разным точкам в соответствии со схемой.
6. Оценить точность преобразования сигнала с помощью ЦАП на базе таймера.

Рис. 5.1. Схема соединений

![Lab 5 wiring diagram](/img/lab5_wiring.png)

Табл. 5.3. Результаты измерений

| Uвх (вывод PF0), B | Uвых(ёмкость 5.6 мкФ), В |
|--------------------|--------------------------|
|         1          |                          |
|         2          |                          |
|         3          |                          |
|         4          |                          |
|         5          |                          |


Листинг 5.1. ЦАП на базе ШИМ сигналов микроконтроллера

```C
/* Exp_5 "ЦАП на базе ШИМ сигналов микроконтроллера"
 * Exp_5.с АЦП микроконтроллера программируется для ввода данных по каналу ADC0 (вывод PF0)
 * c потенциометра миниблока А4. Полученный сигнал АЦП выдается в регистр сравнения OCR1A 
 * таймера 1. При инициализации таймера 1 задан режим работы таймера с разрядностью, 
 * совпадающей с разрядностью АЦП и разрешено формирование ШИМ сигнала на выходе.
 * При задании опорного напряжения АЦП равным напряжению питания и правильной работе 
 * системы, сигнал на входе АЦП и среднее значение ШИМ сигнала должны совпасть.
 * Для получения среднего значения ШИМ сигнал таймера с вывода PB5 микроконтроллера
 * поступает на RC фильтр из элементов миниблока A3. Напряжение на емкости, является выходом
 * ЦАП.  Значения напряжения на входе АЦП и выходе ЦАП могут быть измерены с помощью 
 * мультиметра.
 */ 

#include <avr/io.h>

int main(void)
{
	DDRB |= (1<<PB5);	//вывод ШИМ настроен на выход
	ADMUX=0x40;	//при инициализации АЦП выбираем опорное напряжение 5 В 
			//(напряжение питания) и канал ADC0 
	TCCR1A=0x83;	//ШИМ сигнал на выводе OCR1A (PB5)? fast PWM 10бит
	TCCR1B=0x9;	//тактовая частота таймера 1 МГц
	ADCSRA=0xD2;	//первый запуск АЦП без разрешения прерываний и с тактовой частотой 250 кГц
	while(1)
	{
		if (ADCSRA &(1<<ADIF))
		{//закончилось очередное преобразование АЦП
			OCR1A=ADC;
			ADCSRA=0xD2;			//запускаем следующее преобразование АЦП
		}
		for(unsigned int i=0;i<10000;i++) ;	//цикл, имитирующий основную программу
	}
}
```

Скомпилировать полученный код (см. [Компиляция](Software.md#компиляция-программ-на-языке-c) или с помощью [Makefile](Software.md#make-и-makefile)).

Перевести микроконтроллер в режим программирования: одновременно нажать кнопки "СБРОС" и "ПРОГ", отпустить "СБРОС", затем отпустить "ПРОГ". Микроконтроллер перейдет в режим программирования (DFU) и будет ожидать прошивку.

Выполнить загрузку программы в микроконтроллер (см. [Прошивка](Software.md#прошивка-микроконтроллера) или с помощью [Makefile](Software.md#make-и-makefile)).

Нажать кнопку "СБРОС", микроконтроллер перейдет в рабочий режим.

## Задания для самостоятельной работы

1. Измените программу добавив второй канал ЦАП.
2. Измените программу сделав запуск АЦП по таймеру.
3. Напишите программу формирования пилообразного напряжения.
4. Напишите программу формирования напряжения треугольной формы.

## Содержание отчета

1. Титульный лист
2. Цель, задание на лабораторную работу
3. Электрическая схема
4. Алгоритм работы
5. Заключение
6. Приложения

## Контрольные вопросы

1. Объясните принцип работы ШИМ.
2. Назовите несколько примеров применения ШИМ.
3. Какие режимы ШИМ поддерживает микроконтроллер ATmega16u4?
4. Как настроить таймер на генерацию ШИМ сигнала?
5. Как изменить коэффициент заполнения ШИМ?
6. Объясните принцип работы ЦАП на базе ШИМ.
