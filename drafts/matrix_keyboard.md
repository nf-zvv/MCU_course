# Матричная клавиатура

## Цель

Изучить работу матричной клавиатуры, программный способ опроса состояния кнопок, подавления дребезга контактов.

## Оборудование

1. Миниблок микроконтроллера ATmega16
2. Семисегментный светодиодный индикатор
3. Провода соединительные
4. Кабель USB - miniUSB
5. Блок БИЦУ (наборное поле с источником питания)
6. ПК с ОС GNU/Linux Ubuntu

## Теоретические сведения

Матричная клавиатура представляет собой набор кнопок, замыкающих между собой линии столбцов и строк. У клавиатуры модуля 16 кнопок, объединенных в матрицу 4×4 (рис. 1). Главное преимущество матричной клавиатуры перед простым набором кнопок - экономия выводов микроконтроллера. Причем чем больше кнопок, тем значительнее экономия: для N=a×b кнопок надо a×b линий при прямом подключении или a+b линий при матричном.

![Matrix keyboard](/img/matrix_keyboard.png)

Рис. 1 – Матричная клавиатура

Для считывания информации с матричной клавиатуры от микроконтроллера требуется наличие, как входов, так и выходов. Для определенности будем считать, что столбцы подключены к выходам, а строки к входам (хотя никто не мешает сделать и наоборот). Способ опроса клавиатуры заключается в следующем. На первый столбец подается один логический уровень (как правило, лог. 0), а на остальные - другой (соответственно, лог. 1). Затем выполняется считывание уровней со строк. Если в первом столбце не нажато ни одной кнопки, на всех строках будет считана лог. 1 (не забываем о необходимости подтягивающих резисторов). Если же одна из кнопок нажата, в соответствующей строке считается лог. 0. Затем весь цикл повторяется, но лог. 0 выставляется на втором столбце, далее на третьем и так далее. После прохода последнего столбца опрос клавиатуры можно считать завершенным. Временная диаграмма опроса клавиатуры показана на рис. 2. Поскольку после смены логических уровней на линиях столбцов в цепях начинаются переходные процессы, считывание состояния кнопок с линий строк надо делать с небольшой задержкой, желательно не менее t1>=[0.5-1] мкс.

![Matrix keyboard timings](/img/matrix_keyboard_timings.png)

Рис. 2 - Временная диаграмма работы с матричной клавиатурой

Так как кнопки могут быть нажаты в произвольный момент времени, сканирование матрицы надо проводить периодически, с некоторым интервалом. Человек не заметит задержки, если период определения нажатия/отпускания кнопки будет порядка t3=100 мс или меньше. Для упрощения алгоритма можно принять длительность цикла опроса клавиатуры равной периодичности ее опроса t2=t3, а время задержки взять 1/4 от длительности цикла t1=t2/4 (для 4 столбцов).

Кнопка есть механический элемент, ей присущ дребезг, т.е. неоднократные кратковременные замыкания и размыкание контакта в момент нажатия либо отпускания кнопки. Понятно, что это приводит к нежелательным последствиям в виде дублирования нажатий. Для исключения дребезга на уровне алгоритма опроса клавиатуры проще всего принять, что состояние клавиатуры действительно только тогда, когда при нескольких (минимум двух, оптимально трех) циклах опроса подряд было считано одно и то же состояние кнопок. Удвоение или утроение количества циклов означает необходимость уменьшения периода каждого опроса t3, в противном случае пользователь будет ощущать задержку нажатий и отпусканий кнопок. Можно, например, взять период t3=20 мс, тогда при 4 столбцах период таймера, по которому производится считывание строк и переключение логических уровней на столбцах, будет равен t1=5 мс.


## Ход работы


## Задания для самостоятельной работы


## Содержание отчета

1. Титульный лист
2. Цель, задание на лабораторную работу
3. Электрическая схема
4. Алгоритм работы
5. Заключение
6. Приложения

## Контрольные вопросы

1. Расскажите принцип работы матричной клавиатуры. Для чего применяется эта схема?
2. Какие преимущества и недостатки подключения кнопочных выключателей к микроконтроллеру прямым способом и через матрицирование?
3. Как осуществляется опрос матричной клавиатуры?
4. Почему необходимо делать задержку перед началом считывания состояния линий после смены логических уровней?
5. Что такое «дребезг контакта» и как осуществить защиту от него?
6. Можно ли совмещать опрос матричной клавиатуры с динамической индикацией? Какие преимущества и недостатки есть у таких схем?
