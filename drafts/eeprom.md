# EEPROM

## Цель

Познакомиться с работой EEPROM микроконтроллера. Научиться записывать и считывать данные из встроенной энрегонезависимой памяти микроконтроллера.

## Оборудование

1. Миниблок микроконтроллера ATmega16
2. Два вспомогательных миниблока с семисегментным светодиодным индикатором
3. Провода соединительные
4. Кабель USB - miniUSB
5. Блок БИЦУ (наборное поле с источником питания)
6. ПК с ОС GNU/Linux Ubuntu

## Теоретические сведения

Большинство МК AVR от Atmel содержат EEPROM (Electrically Erasable Programmable Read-Only Memory) - энергонезависимую перезаписываемую память с довольно большим количеством циклов записи. Данные, записанные в эту память, не будут сбрасываться даже при отключении питания, что очень удобно, например, для хранения настроек или каких-то идентификационных данных.

EEPROM имеет ограниченное количество циклов записи - 100 000. Количество циклов чтения не ограничено.

### Регистры для работы с EEPROM

Доступ к EEPROM в AVR можно получить с помощью специальных регистров, которые отвечают за адрес, информацию для записи (или прочитанную информацию) и совершаемое действие (запись/чтение).

**Регистр адреса `EEAR` (EEPROM Address Register)** предназначен для адресации однобайтной ячейки EEPROM памяти, к которой будет производиться обращение.

Для полной адресации хотя бы минимального объема EEPROM памяти (512-ти байт) требуется 9 разрядов (2 в 9-ой степени = 512), поэтому регистр `EEAR` является 16-ти разрядным и физически расположен в двух регистрах ввода/вывода – `EEARH` и `EEARL`. Регистр `EEARL` полностью доступен для записи/чтения. А в регистре `EEARH` для записи/чтения доступны только младшие разряды, используемые для адресации. Остальные разряды доступны только для чтения и содержат «0».

**Регистр данных – `EEDR` (EEPROM Data Register)**. Если выполняется процедура записи, необходимо поместить в `EEDR` байт данных, если выполняется процедура чтения, прочитать байт данных из `EEDR`.

**Регистр управления `EECR` (EEPROM Control Register)** предназначен для управления доступом к EEPROM. Этот регистр содержит 4 бита:

- Бит `EERIE` (EEPROM Ready Interrupt Enable) – разрешение/запрещение прерывания по событию готовности EEPROM. Если бит `EERIE` установлен в 1, установлен флаг глобального разрешения прерываний (бит I регистра `SREG`) и бит `EEWE` очищен, то микроконтроллер будет генерировать прерывание “EEPROM Ready Interrupt”.
- Бит `EEMWE` (EEPROM Master Wirte Enable) - главное разрешение записи. Если в течении 4-ех тактов после установки этого бита, устанавливается бит `EEWE`, то микроконтроллер выполняет запись в EEPROM. Бит `EEMWE` аппаратно сбрасывается в ноль после 4-ех периодов тактовой частоты.
- Бит `EEWE` (EEPROM Write Enable) - разрешение записи. Этот бит выполняет роль стартового сигнала записи в EEPROM. Когда установлен адрес, данные и бит `EEMWE`, установка бита `EEWE` инициирует запись в EEPROM. Бит `EEWE` должен быть установлен в течении 4-ех тактов после установки `EEMWE`. Если это произойдет позже, то запись в EEPROM не будет произведена. Чтобы избежать возможных проблем, рекомендуется запрещать прерывания на время выполнения записи в EEPROM. Бит `EEWE` аппаратно сбрасывается, после завершения операции записи. Поэтому перед каждой операцией записи в EEPROM нужно проверять состояние этого разряда.
- Бит `EERE` (EEPROM Read Enable) - разрешение чтения. Установка бита `EERE` инициирует процесс чтения из EEPROM. Перед каждым циклом чтения нужно проверять состояние разряда `EEWE`, если выполняется операция записи, то чтение из EEPROM не даст результата.

#### Запись в EEPROM на Си

Процедура записи в EEPROM состоит из следующих шагов:

1. Ожидаем готовности EEPROM, опрашивая бит `EEWE` регистра `EECR`.
2. Устанавливаем адрес в регистре `EEAR`.
3. Записываем байт данных в регистр `EEDR`.
4. Устанавливаем основной флаг разрешения записи `EEMWE` регистра `EECE`
5. Устанавливаем флаг разрешения записи `EEWE` регистра `EECE`

> [!NOTE]
> Флаг `EEWE` должен быть установлен в течении 4 циклов после флага `EEMWE`. Если в проекте используются прерывания, то на каком-то из этапов этой последовательности их нужно запрещать. Это можно сделать или в самом начале или перед установкой флага `EEMWE`.

Функция записи для компилятора avr-gcc будет выглядеть следующим образом:

```C
void EEPROM_WritByte(uint16_t *adr, uint8_t value)
{
    while (EECR & (1<<EEWE));
    EEAR = adr;
    EEDR = value;
    EECR |= (1<<EEMWE);
    EECR |= (1<<EEWE);
}
```

Пример использования:

```C
uint16_t data EEMEM;
...
EEPROM_WriteByte(&data, 125);
```

> [!NOTE]
> Макрос `EEMEM` указывает компилятору, что необходимо разместить переменную не в SRAM, а в EEPROM.

#### Чтение из EEPROM на Си

Процедура чтения EEPROM состоит из следующих шагов:

1. Ожидаем готовность EEPROM, опрашивая бит `EEWE` регистра `EECR`.
2. Устанавливаем адрес в регистре `EEAR`.
3. Устанавливаем флаг разрешения чтения `EERE` регистра `EECR`
4. Считываем содержимое регистра данных `EEDR`

Функция чтения для компилятора avr-gcc будет выглядеть следующим образом:

```C
uint8_t EEPROM_ReadByte(uint16_t *adr)
{
    while (EECR & (1<<EEWE));
    EEAR = adr;
    EECR |= (1<<EERE);
    return EEDR;
}
```

Пример использования:

```C
uint16_t data EEMEM;
uint8_t tmp;
...
tmp = EEPROM_ReadByte(&data);
```

### Использование библиотеки для работы с EEPROM

AVRLibC (обычно она входит в состав компилятора AVR-GCC) содержит готовую библиотеку для работы с EEPROM. Чтобы ее использовать, нужно подключить следующий заголовочный файл:

```C
#include <avr/eeprom.h>
```

В этой библиотеке для чтения и записи доступны три основных типа данных: byte (1 байт), word (2 байта) и блок данных. Для каждого типа есть своя функция записи и чтения:

```C
// Читаем / пишем по одному байту (byte)
uint8_t eeprom_read_byte (const uint8_t *addr) 
void eeprom_write_byte (uint8_t *addr, uint8_t value) 

// Читаем / пишем по два байта (word)
uint16_t eeprom_read_word (const uint16_t *addr) 
void eeprom_write_word (uint16_t *addr, uint16_t value) 

// Читаем / пишем блоками
void eeprom_read_block (void *pointer_ram, const void *pointer_eeprom, size_t n) 
void eeprom_write_block (const void *pointer_ram, void *pointer_eeprom, size_t n)
```

> [!NOTE]
> Перед записью в EEPROM следует запретить все прерывания, а после выполнения операции, разрешить.

## Ход работы

## Задания для самостоятельной работы

1. Усовершенствовать проект «Бинарные часы» из практической работы № 2: запоминать время на каждом шаге и восстанавливать счет с прежнего значения после отключания/включения питания.
2. Усовершенствовать проект «Переключатель» из  практической работы № 2: запоминать   состояние включенных светодиодов и восстанавливаться с прежнего состояния после отключания/включения питания. Добавить запрет записи нового значения, если оно не отличается от существующего.
3. Усовершенствовать проект  «Переключатель режимов» из практической работы  № 2: запоминать включанный режим и восстанавливать состояние после отключания/включения питания. Добавить  запрет записи нового значения, если оно не отличается от существующего.

## Содержание отчета

1. Титульный лист
2. Цель, задание на лабораторную работу
3. Электрическая схема
4. Алгоритм работы
5. Заключение
6. Приложения

## Контрольные вопросы

1. Назовите границы адресного пространства EEPROM?
2. Какое количество циклов перезаписи EEPROM доступно?
3. Какие регистры отвечают за работу с энергонезависимой памятью?
4. Опишите алгоритм записи данных в EEPROM?
5. Назовите способы экономии ресурса записи EEPROM?
