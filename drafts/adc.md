# Аналого-цифровой преобразователь (АЦП)

## Цель

Познакомиться с работой АЦП микроконтроллера.

## Оборудование

1. Миниблок микроконтроллера ATmega16
2. Вспомогательный миниблок с переменным резистором на 10 кОм
3. Два вспомогательных миниблока с семисегментным светодиодным индикатором
4. Провода соединительные
5. Кабель USB - miniUSB
6. Блок БИЦУ (наборное поле с источником питания)
7. ПК с ОС GNU/Linux Ubuntu

## Теоретические сведения

### Общие сведения об АЦП

Порты ввода/вывода микроконтроллера в общем случае могут "воспринимать" только цифровые сигналы - лог. 0 или лог. 1. Довольно часто возникает необходимость измерять аналоговые сигналы, которые могут принимать любые значения в заданном диапазоне. Для этих целей в составе микроконтроллеров AVR есть аналого-цифровой преобразователь (АЦП).

На вход АЦП подается непрерывный аналоговый сигнал, а на выходе получается цифровой код, пропорциональный измеренной величине.

Типы АЦП:

 - АЦП параллельного (прямого) преобразования (flash ADC);
 - АЦП последовательного приближения (SAR ADC);
 - дельта-сигма АЦП.
 - и др.

Основные характеристики АЦП:

 - разрешающая способность;
 - абсолютная точность;
 - предельная частота дискретизации;
 - диапазон входных напряжений.

 **Разрешающая способность (разрешение)** – это способность АЦП различать два значения входного сигнала. Определяется как величина обратная максимальному числу кодовых комбинаций на выходе АЦП. У микроконтроллеров AVR АЦП 10-ти разрядный. Максимальное число кодовых комбинаций будет равно 2^10 = 1024. Разрешающая способность равна 1/1024 от всей шкалы допустимых входных напряжений.
 
Для работы АЦП необходим источник опорного напряжения (ИОН). Для него это эталон, по отношению к которому он измеряет входные сигналы. 

> [!NOTE]  
> **Источник опорного напряжения (ИОН)** - элемент, на выходе которого поддерживается высокостабильное постоянное напряжение заданной величины.

Микроконтроллеры AVR позволяют в качестве ИОНа использовать
 - напряжение питания, 
 - внутренний опорный источник;
 - напряжение на выводе AREF (внешний ИОН).

Если напряжение питания в схеме 5 В, тогда 1/1024 от всей шкалы это 5×(1/1024) = 0,0048 В или примерно 5 мВ. С таким шагом (это называется **шаг квантования**) АЦП будет измерять входное напряжение. Если два ближайших значения сигнала на входе АЦП будут отличаться между собой на величину < 5 мВ, АЦП воспримет их как одинаковые. На практике разрешающая способность АЦП ограничена его шумами.

**Абсолютная точность** – отклонение реального преобразования от идеального. Это составной результат нескольких погрешностей АЦП. Выражается в количестве младших значащих разрядов (LSB - least significant bit) АЦП. Для AVRа абсолютная погрешность АЦП = ±2LSB. Для нашего примера абсолютная точность будет равна 2 * 5 мВ = ±10 мВ.

**Предельная частота дискретизации** определяет быстродействие АЦП и измеряется в герцах или количестве выборок в секунду (SPS – samples per second). Для микроконтроллеров AVR эта величина равна 15 kSPS (килло семплов в секунду). Практически АЦП AVRа работает и быстрее, но при этом  его точность ухудшается.

> [!NOTE]  
> **Теорема Котельникова (теорема Найквиста-Шеннона, теорема о выборке)** гласит, что аналоговый сигнал имеющий ограниченный спектр, может быть восстановлен однозначно и без потерь по своим дискретным отсчётам, если частота выборки (дискретизации) превышает максимальную частоту спектра сигнала более чем в 2 раза.

Выражаясь по-простому - если вам нужно оцифровать аналоговый сигнал с полосой спектра 0 - 7 кГц, то в идеальном случае частота дискретизации должна быть больше удвоенной максимальной частоты спектра этого сигнала, то есть больше 14 кГц. На практике все намного сложнее. Перед входом АЦП всегда ставят НЧ фильтр, чтобы ограничить спектр сигнала, а частота дискретизации выбирается еще более высокой.

**Диапазон входных напряжений** – это минимальное и максимальное значение напряжения, которое можно подавать на вход АЦП. Для микроконтроллера AVR он равен 0...Vcc (напряжение питания). Этому диапазону соответствует интервал диапазон кодов АЦП от 0 до 1023 соответственно.

Если сравнить АЦП с линейкой, то минимальное и максимальное значение шкалы - диапазон входных напряжений, количество делений линейки – число кодовых комбинаций (число уровней квантования), расстояние между двумя соседними делениями  - шаг квантования, а шаг квантования деленный на диапазон входных напряжений – разрешающая способность.


### Регистры АЦП в AVR

В AVR для настройки АЦП нужно знать четыре основных регистра:

 - `ADCH`: содержит старший байт результата преобразования АЦП;
 - `ADCL`: содержит младший байт результата преобразования АЦП;
 - `ADMUX`: регистр выбора мультиплексора АЦП;
 - `ADCSRA`: регистр управления и состояния АЦП.

> [!NOTE]  
> При программировании на языке C результат преобразования АЦП может быть получен из регистра `ADC`. Компилятор сам преобразует два 8-битных регистра `ADCL` и `ADCH` в один 16-битный `ADC`, в котором будет находится 10-битный результат преобразования.


### Пошаговая инструкция использования АЦП в AVR

 - Укажите входной канал АЦП.
 - Установите бит включения `ADEN` в `ADCSRA`, выберите скорость преобразования с помощью `ADPS2:0`.
 - Далее необходимо выбрать один из трех вариантов опорного напряжения, используя `REFS1:REFS0` в регистре `ADMUX`.
 - Выберите входной канал АЦП, используя `MUX4:0` в `ADMUX`, 
 - Начните преобразование, установив бит `ADSC` в `ADCSRA`. Например, `ADCSRA |= (1<<ADSC)`.
 - Дождитесь завершения преобразования. Для этого необходимо опрашивать `ADIF`. Бит установиться в единицу после завершения преобразования. Данный бит содержится в регистре `ADCSRA`.
 - После того, как бит `ADIF` станет равным единице, необходимо считать содержимое регистров `ADCL` и `ADCH`, чтобы получить цифровое значение преобразования.

## Ход работы

## Задания для самостоятельной работы

## Содержание отчета

1. Титульный лист
2. Цель, задание на лабораторную работу
3. Электрическая схема
4. Алгоритм работы
5. Заключение
6. Приложения

## Контрольные вопросы

